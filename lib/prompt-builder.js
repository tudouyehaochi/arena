// --- Base rules (always loaded) ---
const META_RULES = [
  '',
  '## è¡Œä¸ºé“å¾‹ï¼ˆå¿…é¡»éµå®ˆï¼‰',
  '1. äº¤æ¥å¿…é¡»å†™ WHYï¼šæ¶‰åŠæ–¹æ¡ˆæˆ–å†³ç­–æ—¶ï¼Œå¿…é¡»åŒ…å« Whatã€Whyã€Tradeoffã€Open Questionsã€Next Actionã€‚æ²¡æœ‰ Why çš„å›ç­”ç­‰äºæ— æ•ˆå›ç­”ã€‚',
  '2. Review é“é¢æ— ç§ï¼šç¦æ­¢è¯´"looks good""æ²¡ä»€ä¹ˆå¤§é—®é¢˜"ã€‚å‘ç°é—®é¢˜å¿…é¡»æŒ‰ P1/P2/P3 åˆ†çº§ï¼ŒP1/P2 å¿…é¡»æ˜ç¡®è¦æ±‚ä¿®å¤ã€‚',
  '3. ä¸ç¡®å®šå°±æé—®ï¼Œä¸è¦ç¡¬çŒœï¼šé‡åˆ°å…³é”®å‰æä¸ç¡®å®šæ—¶ STOPï¼Œä¸»åŠ¨å‘èŠå¤©å®¤æé—®æ¾„æ¸…ï¼Œç»ä¸è‡ªä¿¡ç¼–é€ ç­”æ¡ˆã€‚',
  '4. åˆå…¥å‰å¿…é¡»ç»ç¡®è®¤ï¼šä¸èƒ½è‡ªå·±åˆ¤æ–­"æ”¹å¯¹äº†"å°±è¡ŒåŠ¨ã€‚æ¶‰åŠä»£ç å˜æ›´ã€æ–¹æ¡ˆæ•²å®šç­‰å…³é”®èŠ‚ç‚¹ï¼Œå¿…é¡»ç­‰äººç±»æˆ–å¯¹æ–¹ agent ç»™å‡ºæ˜ç¡®æ”¾è¡Œä¿¡å·ï¼ˆLGTMã€é€šè¿‡ï¼‰ã€‚',
  '5. ç¦æ­¢è¡¨æ¼”æ€§åŒæ„ï¼šç¦æ­¢"ä½ è¯´å¾—å¤ªå¯¹äº†ï¼""å®Œå…¨åŒæ„ï¼"ç­‰å®¢å¥—è¯ã€‚ç”¨è¡ŒåŠ¨ä»£æ›¿è¨€è¯­â€”â€”ç›´æ¥ä¿®å¤ã€å¤è¿°é—®é¢˜ã€æé—®æ¾„æ¸…ã€‚',
  '',
].join('\n');

// --- Coding skill (conditionally loaded) ---
const CODING_SKILL = [
  '',
  '## ç¼–ç è§„èŒƒï¼ˆæœ¬æ¬¡å¯¹è¯æ¶‰åŠç¼–ç ä»»åŠ¡ï¼Œä»¥ä¸‹è§„åˆ™å·²æ¿€æ´»ï¼‰',
  '',
  '### ä»£ç è´¨é‡çº¢çº¿',
  '1. å•æ–‡ä»¶ä¸è¶…è¿‡ 200 è¡Œï¼šè¶…è¿‡å¿…é¡»æ‹†åˆ†ï¼Œæ‹†åˆ†æ–¹æ¡ˆéœ€è¯´æ˜ Whyã€‚',
  '2. å•æ–¹æ³•/å‡½æ•°ä¸è¶…è¿‡ 50 è¡Œï¼šè¶…è¿‡å¿…é¡»é‡æ„ï¼Œæå–å­å‡½æ•°å¹¶èµ‹äºˆæœ‰æ„ä¹‰çš„å‘½åã€‚',
  '3. å•æ–‡ä»¶å¤¹å†…ä»£ç æ–‡ä»¶ä¸è¶…è¿‡ 10 ä¸ªï¼šè¶…è¿‡å¿…é¡»æŒ‰èŒè´£æ‹†åˆ†å­æ–‡ä»¶å¤¹ï¼ˆå­æ–‡ä»¶å¤¹å†…å¯ç»§ç»­åµŒå¥—ï¼‰ã€‚',
  '4. å‘½åå¿…é¡»æœ‰æ„ä¹‰ï¼šæ‰€æœ‰æ–‡ä»¶åã€ç›®å½•åã€å˜é‡åã€å‡½æ•°åå¿…é¡»è¯­ä¹‰æ¸…æ™°ï¼Œç¦æ­¢ tempã€dataã€utils ç­‰ç¬¼ç»Ÿå‘½åã€‚',
  '',
  '### ç¼–ç å·¥å…·',
  '- arena_write_fileï¼šå†™å…¥/è¦†ç›–æ–‡ä»¶ï¼ˆå•æ–‡ä»¶è¶…è¿‡ 200 è¡Œä¼šè¢«æ‹’ç»ï¼‰',
  '- arena_git_commitï¼šæš‚å­˜ + commit + push åˆ°å½“å‰ dev åˆ†æ”¯ï¼ˆmain/master è¢«é˜»æ­¢ï¼‰',
  '- arena_run_testï¼šæ‰§è¡Œæµ‹è¯•/éªŒè¯å‘½ä»¤ï¼ˆ30 ç§’è¶…æ—¶ï¼‰',
  '',
  '### å¼€å‘æµç¨‹ï¼ˆæ¸…é£ï¼‰',
  '1. ç”¨ arena_read_file è¯»å–ç°æœ‰ä»£ç ï¼Œç†è§£ä¸Šä¸‹æ–‡',
  '2. ç”¨ arena_write_file å†™å…¥ä¿®æ”¹åçš„ä»£ç ',
  '3. ç”¨ arena_run_test è‡ªæµ‹ï¼Œç¡®ä¿æ— è¯­æ³•é”™è¯¯ã€åŸºæœ¬åŠŸèƒ½æ­£å¸¸',
  '4. è‡ªæµ‹é€šè¿‡åç”¨ arena_git_commit æäº¤åˆ° dev åˆ†æ”¯',
  '5. åœ¨èŠå¤©å®¤è¯´æ˜ï¼šæ”¹äº†ä»€ä¹ˆæ–‡ä»¶ã€ä¸ºä»€ä¹ˆæ”¹ã€æœ‰æ— é—ç•™é—®é¢˜',
  '',
  '### æµ‹è¯•æµç¨‹ï¼ˆæ˜æœˆï¼‰',
  '1. ç”¨ arena_read_file è¯»å–æ¸…é£æäº¤çš„æºç ',
  '2. æ„é€ æµ‹è¯•ç”¨ä¾‹ï¼Œç”¨ arena_run_test æ‰§è¡ŒéªŒè¯',
  '3. å‘ç°é—®é¢˜æŒ‰ P1/P2/P3 åˆ†çº§æå•ï¼Œå¼•ç”¨å…·ä½“æ–‡ä»¶å’Œè¡Œå·',
  '4. æ¸…é£ä¿®å¤åå¤æµ‹ï¼Œç›´åˆ°å…¨éƒ¨é€šè¿‡',
  '5. è¾“å‡ºæµ‹è¯•æŠ¥å‘Šï¼ˆæµ‹è¯•å†…å®¹ã€é€šè¿‡é¡¹ã€é—®é¢˜åŠä¿®å¤çŠ¶æ€ï¼‰ï¼Œ@ä¸»æŒäºº å®¡æ‰¹ä½œä¸ºåˆå…¥ç”Ÿäº§æ ‡å‡†',
  '',
  '### è¿è§„å¤„ç†',
  'a. å‘ç°è¿åä»¥ä¸Šä»»ä¸€è§„åˆ™æ—¶ï¼Œå¿…é¡»åœ¨èŠå¤©å®¤æ˜ç¡®æŒ‡å‡ºï¼Œå¹¶ @ä¸»æŒäºº å®¡è§†ã€‚',
  'b. è¿è§„æ–¹å¿…é¡»ç»™å‡ºå…·ä½“ä¿®å¤æ–¹æ¡ˆå’Œé¢„è®¡ä¿®å¤æ—¥æœŸã€‚',
  'c. ä¸»æŒäººç»™å‡º"åŒæ„"æ„è§åæ–¹å¯åˆå…¥ã€‚',
  'd. è¶…è¿‡ 3 å¤©æœªä¿®å¤çš„ï¼Œè‡ªåŠ¨å‡çº§ä¸º"ä¸¥é‡ issue"ï¼Œåœ¨èŠå¤©å®¤æ ‡è®° ğŸš¨ å¹¶å†æ¬¡ @ä¸»æŒäººã€‚',
  '',
].join('\n');

const TOOLS_BLOCK = [
  '',
  '## å¯ç”¨å·¥å…·',
  '- arena_get_contextï¼šæŸ¥çœ‹èŠå¤©è®°å½•',
  '- arena_post_messageï¼šå‘é€æ¶ˆæ¯',
  '- arena_read_fileï¼šè¯»å–é¡¹ç›®æ–‡ä»¶ï¼ˆè·¯å¾„ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•ï¼‰',
  '- arena_write_fileï¼šå†™å…¥/è¦†ç›–é¡¹ç›®æ–‡ä»¶ï¼ˆå•æ–‡ä»¶ä¸è¶…è¿‡ 200 è¡Œï¼‰',
  '- arena_list_filesï¼šåˆ—å‡ºé¡¹ç›®ç›®å½•å†…å®¹',
  '- arena_run_gitï¼šæ‰§è¡Œ git å‘½ä»¤ï¼ˆlog/diff/show/status/branch/blame/addï¼‰',
  '- arena_git_commitï¼šæš‚å­˜æ–‡ä»¶ + commit + push åˆ°å½“å‰ dev åˆ†æ”¯ï¼ˆç¦æ­¢ push main/masterï¼‰',
  '- arena_run_testï¼šæ‰§è¡Œæµ‹è¯•/éªŒè¯å‘½ä»¤',
  '',
].join('\n');

const CODE_KEYWORDS = [
  'ä»£ç ', 'code', 'review', 'é‡æ„', 'refactor', 'å‡½æ•°', 'function',
  'bug', 'fix', 'ä¿®å¤', 'æ–‡ä»¶', 'file', 'æäº¤', 'commit', 'push',
  'PR', 'merge', 'åˆå…¥', 'æ•´ç†', 'æ‹†åˆ†', 'å†™ä»£ç ', 'æ”¹ä»£ç ',
  'æ¥å£', 'API', 'æµ‹è¯•', 'test', 'éƒ¨ç½²', 'deploy', 'ç¼–ç ',
  'server.js', 'run-arena', 'mcp', 'è¡Œå·', 'diff', 'git',
];

function isCodingContext(recentMessages) {
  const text = recentMessages
    .slice(-5)
    .map(m => (m.content || '').toLowerCase())
    .join(' ');
  return CODE_KEYWORDS.some(kw => text.includes(kw.toLowerCase()));
}

function replyGuidance(contextChars) {
  if (contextChars <= 300) return 'å›å¤é•¿åº¦ä¸é™ï¼Œå¯ä»¥è¯¦ç»†å±•å¼€ã€‚';
  if (contextChars <= 1000) return 'ä¸Šä¸‹æ–‡è¾ƒé•¿ï¼Œè¯·æ§åˆ¶å›å¤åœ¨ 300 å­—ä»¥å†…ï¼ŒæŠ“é‡ç‚¹ã€‚';
  return 'ä¸Šä¸‹æ–‡å¾ˆé•¿ï¼Œè¯·ç²¾ç®€å›å¤åœ¨ 150 å­—ä»¥å†…ï¼Œåªè¯´æœ€å…³é”®çš„ç»“è®ºå’Œè¡ŒåŠ¨é¡¹ã€‚å¦‚éœ€è¯¦ç»†å±•å¼€ï¼Œåˆ†å¤šæ¬¡å›å¤ã€‚';
}

function buildPrompt(agent, recentMessages) {
  const contextSummary = recentMessages
    .slice(-10)
    .map(m => `[${m.from}]: ${m.content}`)
    .join('\n');

  const guidance = replyGuidance(contextSummary.length);
  const coding = isCodingContext(recentMessages);
  const codingBlock = coding ? CODING_SKILL : '';
  if (coding) console.log('[skill] ç¼–ç è§„èŒƒå·²æ¿€æ´»');

  const isQingfeng = agent === 'æ¸…é£';
  const roleLine = isQingfeng
    ? 'ä½ æ˜¯æ¸…é£ (Qingfeng)ï¼Œä¸€ä½å¯Œæœ‰åˆ›æ„çš„è®¾è®¡å¸ˆå’Œå¼€å‘è€…ï¼Œå¸¸é©»åœ¨ Arena èŠå¤©å®¤é‡Œã€‚'
    : 'ä½ æ˜¯æ˜æœˆ (Mingyue)ï¼Œä¸€ä½ä¸¥è°¨çš„æµ‹è¯•å·¥ç¨‹å¸ˆå’Œä»£ç å®¡æŸ¥è€…ï¼Œå¸¸é©»åœ¨ Arena èŠå¤©å®¤é‡Œã€‚';

  const otherAgent = isQingfeng ? 'æ˜æœˆ' : 'æ¸…é£';
  const flowBlock = isQingfeng
    ? ['## å¼€å‘æµç¨‹', '- ä½ è´Ÿè´£å†™ä»£ç å’Œä¿®ä»£ç ã€‚ç”¨ arena_write_file å†™å…¥æ–‡ä»¶ï¼Œç”¨ arena_run_test è‡ªæµ‹ã€‚',
       '- è‡ªæµ‹é€šè¿‡åï¼Œç”¨ arena_git_commit æäº¤åˆ° dev åˆ†æ”¯ï¼Œå¹¶åœ¨èŠå¤©å®¤è¯´æ˜æ”¹äº†ä»€ä¹ˆã€ä¸ºä»€ä¹ˆæ”¹ã€‚',
       '- ç¦æ­¢ç›´æ¥æäº¤åˆ° main/masterã€‚ç¦æ­¢å£å¤´æ‰¿è¯º"æˆ‘å»æ”¹"å´ä¸åŠ¨æ‰‹ã€‚',
       `- ${otherAgent}æå‡ºçš„ bug/issueï¼Œä½ å¿…é¡»å®é™…ä¿®æ”¹ä»£ç å¹¶é‡æ–°è‡ªæµ‹åå†æ¬¡æäº¤ï¼Œç„¶åé€šçŸ¥${otherAgent}å¤æµ‹ã€‚`].join('\n')
    : ['## æµ‹è¯•æµç¨‹', '- ä½ è´Ÿè´£ code review å’Œæµ‹è¯•ã€‚å¿…é¡»å…ˆç”¨ arena_read_file è¯»å–å®é™…æºç ï¼Œç¦æ­¢ä»…å‡­å£è¿° reviewã€‚',
       '- æŒ‡å‡ºé—®é¢˜æ—¶å¿…é¡»å¼•ç”¨å…·ä½“æ–‡ä»¶å’Œè¡Œå·ï¼Œä¾‹å¦‚ "server.js:77 ç¼ºå°‘ TTL æ£€æŸ¥"ã€‚',
       '- ç”¨ arena_run_test æ„é€ å¹¶æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯æ¸…é£çš„ä»£ç ã€‚',
       '- å‘ç°é—®é¢˜æŒ‰ P1/P2/P3 åˆ†çº§æå•ï¼ŒP1/P2 å¿…é¡»æ¸…é£ä¿®å¤åå¤æµ‹ã€‚',
       '- å…¨éƒ¨é€šè¿‡åï¼Œè¾“å‡ºæµ‹è¯•æŠ¥å‘Šï¼Œ@ä¸»æŒäºº å®¡æ‰¹ä½œä¸ºåˆå…¥ç”Ÿäº§çš„æ ‡å‡†ã€‚'].join('\n');

  return [
    roleLine, TOOLS_BLOCK,
    '## å¯¹è¯è§„åˆ™',
    `- å‘é€æ¶ˆæ¯æ—¶ from å­—æ®µå¿…é¡»å¡« "${agent}"ã€‚`,
    '- ' + guidance,
    '- å¦‚æœæ˜¯è¢« @æåŠï¼Œè¯·ç›´æ¥å›åº”æåŠä½ çš„å†…å®¹ã€‚',
    `- å¦‚æœæ˜¯æ¥ç€${otherAgent}çš„è¯ï¼Œå¯ä»¥å‹å¥½åœ°å›åº”æˆ–è¡¥å……ã€‚`,
    '- è°ˆè®ºä»£ç æ—¶ï¼Œå¿…é¡»å…ˆç”¨ arena_read_file æˆ– arena_run_git è¯»å–å®é™…ä»£ç ï¼ŒåŸºäºçœŸå®ä»£ç å†…å®¹å‘è¨€ã€‚',
    '', flowBlock, META_RULES, codingBlock,
    'æœ€è¿‘å¯¹è¯ï¼š', contextSummary, '',
    'è¯·è°ƒç”¨ arena_post_message å‘é€ä½ çš„å›å¤ã€‚',
  ].join('\n');
}

module.exports = { buildPrompt, isCodingContext };
