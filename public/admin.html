<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Arena Admin</title>
<style>
:root{--bg:#f5f7fb;--card:#fff;--line:#dce3ee;--ink:#1f2937;--muted:#64748b;--ok:#16a34a;--warn:#d97706;--bad:#dc2626}
*{box-sizing:border-box}body{margin:0;background:var(--bg);font-family:"Avenir Next","PingFang SC",sans-serif;color:var(--ink)}
.wrap{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
.h{display:flex;align-items:center;gap:8px}.sp{margin-left:auto}.btn{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:8px}.kv{border:1px solid var(--line);border-radius:8px;padding:8px}.k{font-size:12px;color:var(--muted)}.v{font-weight:700}
.tbl{width:100%;border-collapse:collapse}.tbl th,.tbl td{border-bottom:1px solid var(--line);padding:6px 4px;text-align:left;font-size:13px}
.bad{color:var(--bad)}.warn{color:var(--warn)}.ok{color:var(--ok)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card h"><strong>Arena Admin</strong><span id="stamp" class="sp"></span><button id="refresh" class="btn">刷新</button><button id="check" class="btn">运行完整性校验</button></div>
  <div class="card"><div class="h"><strong>运行状态</strong></div><div id="runtime" class="grid"></div></div>
  <div class="card"><div class="h"><strong>完整性与房间</strong></div><div id="integrity"></div></div>
  <div class="card"><div class="h"><strong>告警</strong></div><table class="tbl"><thead><tr><th>时间</th><th>级别</th><th>事件</th><th>详情</th><th>操作</th></tr></thead><tbody id="alerts"></tbody></table></div>
  <div class="card"><div class="h"><strong>备份</strong></div><table class="tbl"><thead><tr><th>文件</th><th>大小</th><th>时间</th></tr></thead><tbody id="backups"></tbody></table></div>
</div>
<script>
(()=>{
  const $=(id)=>document.getElementById(id);
  function esc(s){const d=document.createElement('div');d.textContent=String(s??'');return d.innerHTML;}
  function fmtBytes(n){const v=Number(n||0);if(v<1024)return v+' B';if(v<1024*1024)return (v/1024).toFixed(1)+' KB';if(v<1024*1024*1024)return (v/1024/1024).toFixed(1)+' MB';return (v/1024/1024/1024).toFixed(2)+' GB';}
  function levelClass(l){if(l==='CRITICAL')return'bad';if(l==='WARN')return'warn';return'ok';}
  async function load(){
    const res=await fetch('/api/admin/status');
    const data=await res.json();
    if(!res.ok){alert('加载失败: '+(data.error||res.status));return;}
    $('stamp').textContent='更新时间: '+new Date().toLocaleString();
    const r=data.runtime||{};
    $('runtime').innerHTML=[
      ['Redis', r.redisReady?'READY':'DOWN'],['Redis URL',r.redisUrl||''],['Redis Ver',r.redisVersion||''],['Clients',r.connectedClients||0],
      ['Memory',r.usedMemoryHuman||fmtBytes(r.usedMemory)],['AOF',String(r.aofEnabled)],['Rooms',data.rooms?.total||0],['PID',r.pid||'']
    ].map(x=>`<div class="kv"><div class="k">${esc(x[0])}</div><div class="v">${esc(x[1])}</div></div>`).join('');
    const integ=data.integrity;
    if(!integ){$('integrity').innerHTML='<span class="warn">尚未运行完整性校验</span>';}else{
      const cls=integ.ok?'ok':'bad';
      $('integrity').innerHTML=`<div class="${cls}">状态: ${integ.ok?'PASS':'FAIL'} | rooms=${integ.roomCount} messages=${integ.totalMessages} issues=${(integ.issues||[]).length}</div>`+
      `<div>最近检查: ${esc(integ.checkedAt||'')}</div>`;
    }
    $('alerts').innerHTML=(data.alerts||[]).map(a=>`<tr><td>${esc(a.ts)}</td><td class="${levelClass(a.level)}">${esc(a.level)}</td><td>${esc(a.event)}</td><td>${esc(JSON.stringify(a.detail||{}))}</td><td>${a.acked?'已确认':`<button class="btn" data-ack="${esc(a.id)}">确认</button>`}</td></tr>`).join('');
    document.querySelectorAll('[data-ack]').forEach((b)=>b.onclick=async()=>{await fetch('/api/admin/alerts/ack',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:b.dataset.ack})});load();});
    $('backups').innerHTML=(data.backups||[]).map(b=>`<tr><td>${esc(b.name)}</td><td>${esc(fmtBytes(b.size))}</td><td>${esc(b.mtime)}</td></tr>`).join('');
  }
  $('refresh').onclick=()=>load().catch((e)=>alert(e.message));
  $('check').onclick=async()=>{const r=await fetch('/api/admin/check',{method:'POST'});const d=await r.json();if(!r.ok)alert('校验失败: '+(d.error||r.status));await load();};
  load().catch((e)=>alert(e.message));
})();
</script>
</body>
</html>
