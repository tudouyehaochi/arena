<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arena Chatroom</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; height: 100vh; display: flex; flex-direction: column; }
  #header { padding: 12px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #333; flex-wrap: wrap; }
  #header h1 { font-size: 18px; }
  .env-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
  .env-dev { background: #22c55e; color: #000; }
  .env-prod { background: #ef4444; color: #fff; }
  #room-badge { font-size: 12px; color: #93c5fd; }
  #status { margin-left: auto; font-size: 12px; color: #888; }
  #messages { flex: 1; overflow-y: auto; padding: 16px 20px; display: flex; flex-direction: column; gap: 8px; }
  .msg { padding: 8px 12px; border-radius: 8px; background: #16213e; max-width: 80%; word-wrap: break-word; }
  .msg .meta { font-size: 11px; color: #888; margin-bottom: 2px; }
  .msg .meta .name { color: #60a5fa; font-weight: 600; }
  .msg.system { background: #2d2d44; color: #aaa; font-style: italic; align-self: center; text-align: center; font-size: 13px; }
  #input-area { padding: 12px 20px; border-top: 1px solid #333; display: flex; gap: 8px; }
  #username { width: 100px; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #16213e; color: #eee; font-size: 14px; }
  #msg-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #16213e; color: #eee; font-size: 14px; }
  #send-btn { padding: 10px 20px; border-radius: 8px; border: none; background: #3b82f6; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; }
</style>
</head>
<body>
<div id="header">
  <h1>Arena</h1>
  <span id="env-badge" class="env-badge">...</span>
  <span id="room-badge"></span>
  <span id="status">connecting...</span>
</div>
<div id="messages"></div>
<div id="input-area">
  <input id="username" value="镇元子" placeholder="Name" />
  <input id="msg-input" placeholder="Type a message..." autocomplete="off" />
  <button id="send-btn">Send</button>
</div>
<script>
(function() {
  const messagesEl = document.getElementById('messages');
  const msgInput = document.getElementById('msg-input');
  const usernameInput = document.getElementById('username');
  const sendBtn = document.getElementById('send-btn');
  const envBadge = document.getElementById('env-badge');
  const roomBadge = document.getElementById('room-badge');
  const statusEl = document.getElementById('status');
  const qs = new URLSearchParams(location.search);
  const roomId = (qs.get('roomId') || 'default').trim();
  let ws;

  const savedName = localStorage.getItem('arena_name');
  if (savedName) usernameInput.value = savedName;
  usernameInput.addEventListener('change', () => localStorage.setItem('arena_name', usernameInput.value || '镇元子'));

  fetch('/api/env').then((r) => r.json()).then((info) => {
    envBadge.textContent = info.environment + ' / ' + info.branch;
    envBadge.className = 'env-badge env-' + info.environment;
    roomBadge.textContent = 'room=' + roomId;
  }).catch(() => { roomBadge.textContent = 'room=' + roomId; });

  async function connect() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const tokenResp = await fetch('/api/ws-token?roomId=' + encodeURIComponent(roomId)).then((r) => r.json());
    const wsUrl = proto + '//' + location.host + '/?token=' + encodeURIComponent(tokenResp.token || '') + '&roomId=' + encodeURIComponent(roomId);
    ws = new WebSocket(wsUrl);
    ws.onopen = () => { statusEl.textContent = 'connected'; statusEl.style.color = '#22c55e'; };
    ws.onclose = () => { statusEl.textContent = 'disconnected - reconnecting...'; statusEl.style.color = '#ef4444'; setTimeout(connect, 2000); };
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'history') { messagesEl.innerHTML = ''; data.messages.forEach(renderMessage); }
      else { renderMessage(data); }
      messagesEl.scrollTop = messagesEl.scrollHeight;
    };
  }

  function renderMessage(msg) {
    const div = document.createElement('div');
    div.className = 'msg';
    if (msg.type === 'system') {
      div.classList.add('system'); div.textContent = msg.text;
    } else {
      const meta = document.createElement('div');
      meta.className = 'meta';
      const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : '--:--:--';
      meta.innerHTML = '<span class="name">' + esc(msg.from || '镇元子') + '</span> &middot; ' + time;
      div.appendChild(meta);
      const text = document.createElement('div');
      text.style.whiteSpace = 'pre-wrap';
      text.textContent = msg.text || msg.content || '';
      div.appendChild(text);
    }
    messagesEl.appendChild(div);
  }

  function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function sendMsg(type, text) {
    if (!ws || ws.readyState !== 1) return;
    ws.send(JSON.stringify({ from: usernameInput.value || '镇元子', text, type: type || 'chat', timestamp: Date.now(), roomId }));
  }
  function send() {
    const text = msgInput.value.trim();
    if (!text) return;
    sendMsg('chat', text);
    msgInput.value = '';
  }

  sendBtn.addEventListener('click', send);
  msgInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') send(); });
  connect().catch(() => { statusEl.textContent = 'connect failed'; });
})();
</script>
</body>
</html>
