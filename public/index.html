<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arena Chatroom</title>
<style>
:root{--bg:#f3f6fb;--ink:#1f2937;--muted:#6b7280;--panel:#fff;--line:#dbe3ef;--brand:#2563eb;--radius:16px}
*{box-sizing:border-box}body{margin:0;font-family:"Avenir Next","SF Pro Text","PingFang SC",sans-serif;color:var(--ink);background:radial-gradient(1200px 600px at -20% -10%,#dbeafe 0,#f3f6fb 50%),radial-gradient(1200px 700px at 120% 120%,#e0f2fe 0,#f3f6fb 55%);height:100vh}
.layout{display:grid;grid-template-columns:340px 1fr;height:100vh;gap:14px;padding:14px}
.sidebar,.main{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(15,23,42,.06)}
.sidebar{padding:14px;display:flex;flex-direction:column;gap:12px;overflow:auto}.main{display:flex;flex-direction:column;overflow:hidden}
.head{display:flex;align-items:center;gap:10px}.dot{width:10px;height:10px;border-radius:99px;background:#22c55e}.title{font-size:18px;font-weight:700}.meta{font-size:12px;color:var(--muted)}
.tag{font-size:12px;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#334155;font-weight:600}
.row{display:flex;align-items:center;gap:8px}.sp{margin-left:auto}
.statgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}.stat{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:10px}.stat .k{font-size:11px;color:var(--muted)}.stat .v{font-weight:700;margin-top:4px}
.agent{border:1px solid var(--line);border-radius:14px;padding:10px;background:linear-gradient(180deg,#fff,#f8fbff)}.avatar{width:34px;height:34px;border-radius:999px;display:grid;place-items:center;font-weight:700;color:#fff}
.name{font-weight:700}.sub{font-size:12px;color:var(--muted)}.pill{margin-left:auto;font-size:11px;padding:3px 8px;border-radius:999px;background:#ecfeff;color:#155e75}.line{margin-top:8px;font-size:12px;color:#334155}
.rooms{border:1px solid var(--line);border-radius:12px;padding:8px;background:#f8fafc}.rooms h4{font-size:12px;margin:0 0 8px;color:#475569}.rooms .list{display:flex;flex-wrap:wrap;gap:6px}
.rbtn{font-size:12px;border:1px solid var(--line);background:#fff;padding:4px 8px;border-radius:999px;cursor:pointer}.rbtn.active{background:#dbeafe;border-color:#93c5fd}
.header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,#fff,#f9fbff)}
.messages{flex:1;overflow:auto;padding:14px 16px;display:flex;flex-direction:column;gap:10px}
.msg{max-width:72%;padding:10px 12px;border-radius:16px;border:1px solid var(--line);box-shadow:0 4px 14px rgba(15,23,42,.04)}
.msg .m{font-size:11px;color:var(--muted);margin-bottom:4px}.msg.system{align-self:center;background:#f8fafc;color:var(--muted);max-width:90%;text-align:center}
.msg.mine{align-self:flex-end;background:#ecfdf5;border-color:#bbf7d0;border-bottom-right-radius:8px}
.msg.qingfeng{align-self:flex-start;background:#ecfeff;border-color:#99f6e4;border-bottom-left-radius:8px}
.msg.mingyue{align-self:flex-start;background:#eff6ff;border-color:#bfdbfe;border-bottom-left-radius:8px}
.msg.other{align-self:flex-start;background:#fff;border-bottom-left-radius:8px}
.input{display:flex;gap:8px;padding:12px;border-top:1px solid var(--line);background:#fff}
.input input{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff;color:var(--ink)}#username{width:110px}#msg{flex:1}
button{border:none;background:var(--brand);color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}.ghost{background:#fff;color:#1e3a8a;border:1px solid #bfdbfe}
@media (max-width:920px){.layout{grid-template-columns:1fr}.sidebar{max-height:42vh}}
</style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="head"><span class="dot"></span><div><div class="title">Arena Monitor</div><div id="env" class="meta"></div></div></div>
    <div class="row"><span id="room" class="tag"></span><span id="status" class="meta sp">connecting...</span></div>
    <div class="row"><button id="new-room" class="ghost">+ 新建聊天窗口</button></div>
    <div class="rooms"><h4>聊天窗口</h4><div id="rooms" class="list"></div></div>
    <div class="statgrid"><div class="stat"><div class="k">总消息</div><div id="s-msg" class="v">0</div></div><div class="stat"><div class="k">Agent 连续轮次</div><div id="s-turn" class="v">0</div></div></div>
    <div id="agents"></div>
  </aside>
  <section class="main">
    <div class="header"><strong>Chat</strong><span class="meta">多 Agent 状态可视化</span></div>
    <div id="messages" class="messages"></div>
    <div class="input"><input id="username" value="镇元子" placeholder="Name"><input id="msg" placeholder="Type a message..."><button id="send">Send</button></div>
  </section>
</div>
<script>
(() => {
  const qs = new URLSearchParams(location.search); const roomId = (qs.get('roomId') || 'default').trim();
  const ui = { env:document.getElementById('env'), room:document.getElementById('room'), status:document.getElementById('status'), sMsg:document.getElementById('s-msg'), sTurn:document.getElementById('s-turn'), agents:document.getElementById('agents'), messages:document.getElementById('messages'), username:document.getElementById('username'), msg:document.getElementById('msg'), send:document.getElementById('send'), rooms:document.getElementById('rooms'), newRoom:document.getElementById('new-room')};
  let ws; const saved = localStorage.getItem('arena_name'); if (saved) ui.username.value = saved; ui.username.addEventListener('change', () => localStorage.setItem('arena_name', ui.username.value || '镇元子')); ui.room.textContent = 'room: ' + roomId;
  function fmtTime(ts){return ts?new Date(ts).toLocaleTimeString():'--'} function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
  function bubbleClass(m){const from=m.from||''; if((from)===(ui.username.value||'镇元子')) return 'mine'; if(from==='清风') return 'qingfeng'; if(from==='明月') return 'mingyue'; return 'other';}
  function renderAgentCard(a){const u=a.usage||{}; return `<div class="agent"><div class="row"><div class="avatar" style="background:${a.color||'#64748b'}">${esc(a.avatar||a.name[0])}</div><div><div class="name">${esc(a.name)}</div><div class="sub">${esc(a.model||'unknown')}</div></div><span class="pill">${esc(a.status||'idle')}</span></div><div class="line">调用: ${u.invokeCount||0} 次 · 平均上下文: ${u.avgPromptChars||0} chars</div><div class="line">消息: ${a.messageCount||0} · 最近活跃: ${fmtTime(a.lastSeenAt||u.lastInvokeAt)}</div>${a.currentGoal?`<div class="line">目标: ${esc(a.currentGoal)}</div>`:''}${a.lastFile?`<div class="line">文件: ${esc(a.lastFile)}</div>`:''}</div>`;}
  function renderRoomButtons(rooms){ui.rooms.innerHTML=(rooms||[]).map(r=>`<button class="rbtn ${r.roomId===roomId?'active':''}" data-room="${esc(r.roomId)}">${esc(r.title||r.roomId)}</button>`).join(''); ui.rooms.querySelectorAll('.rbtn').forEach(b=>b.onclick=()=>{const id=b.getAttribute('data-room'); location.href='/?roomId='+encodeURIComponent(id);});}
  async function refreshDashboard(){const [env,dash,roomsRes]=await Promise.all([fetch('/api/env').then(r=>r.json()), fetch('/api/dashboard?roomId='+encodeURIComponent(roomId)).then(r=>r.json()), fetch('/api/rooms').then(r=>r.json())]); ui.env.textContent=`${env.environment} / ${env.branch} / ${env.port}`; ui.sMsg.textContent=String(dash.totalMessages||0); ui.sTurn.textContent=String(dash.agentTurns||0); ui.agents.innerHTML=(dash.agents||[]).map(renderAgentCard).join(''); renderRoomButtons(roomsRes.rooms||[]);}
  function renderMessage(m){const cls=m.type==='system'?'system':bubbleClass(m); const text=m.text||m.content||''; const meta=m.type==='system'?'':`<div class="m">${esc(m.from||'unknown')} · ${fmtTime(m.timestamp)}</div>`; const div=document.createElement('div'); div.className='msg '+cls; div.innerHTML=meta+`<div style="white-space:pre-wrap">${esc(text)}</div>`; ui.messages.appendChild(div); ui.messages.scrollTop=ui.messages.scrollHeight;}
  async function connect(){const proto=location.protocol==='https:'?'wss:':'ws:'; const token=await fetch('/api/ws-token?roomId='+encodeURIComponent(roomId)).then(r=>r.json()); const wsUrl=`${proto}//${location.host}/?token=${encodeURIComponent(token.token||'')}&roomId=${encodeURIComponent(roomId)}`; ws=new WebSocket(wsUrl); ws.onopen=()=>{ui.status.textContent='online';refreshDashboard().catch(()=>{})}; ws.onclose=()=>{ui.status.textContent='reconnecting...';setTimeout(connect,2000)}; ws.onmessage=(ev)=>{const data=JSON.parse(ev.data); if(data.type==='history'){ui.messages.innerHTML='';(data.messages||[]).forEach(renderMessage);} else renderMessage(data); refreshDashboard().catch(()=>{});};}
  async function createRoom(){const raw=prompt('输入新聊天窗口 ID（英文/数字/.-_）'); if(!raw) return; const id=raw.trim(); if(!id) return; const r=await fetch('/api/rooms',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomId:id,title:id,createdBy:ui.username.value||'镇元子'})}); const data=await r.json(); if(!r.ok){alert('创建失败: '+(data.error||r.status)); return;} location.href='/?roomId='+encodeURIComponent(data.roomId);}
  function send(){const text=ui.msg.value.trim(); if(!text||!ws||ws.readyState!==1) return; ws.send(JSON.stringify({from:ui.username.value||'镇元子',text,type:'chat',timestamp:Date.now(),roomId})); ui.msg.value='';}
  ui.send.onclick=send; ui.msg.onkeydown=(e)=>{if(e.key==='Enter')send()}; ui.newRoom.onclick=()=>createRoom().catch(()=>{});
  refreshDashboard().catch(()=>{}); setInterval(()=>refreshDashboard().catch(()=>{}),5000); connect().catch(()=>{ui.status.textContent='connect failed'});
})();
</script>
</body>
</html>
